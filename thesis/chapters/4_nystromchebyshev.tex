\chapter{The Nystr\"om-Chebyshev++ method}
\label{chp:4-nystromchebyshev}

The idea from \cite{lin2017randomized} is to combine low-rank approximation
with stochastic trace estimation. Recent theoretical developments confirm the
efficacy of this approach \cite{meyer2021hutch,persson2022hutch}. In general,
this is done by first computing a low-rank approximation $\widehat{\mtx{B}} \approx \mtx{B}$
for which we can directly compute the trace and subsequently using the
Hutchinson's trace estimator \refequ{equ:2-chebyshev-DGC-hutchinson}
to estimate the trace of the residual
\begin{equation}
    \mtx{\Delta} = \mtx{B} - \widehat{\mtx{B}},
    \label{equ:4-nystromchebyshev-residual}
\end{equation}
such that the final trace estimate is
\begin{equation}
    \Tr(\mtx{B}) \approx \Tr(\widehat{\mtx{B}}) + \Hutch(\mtx{\Delta}).
    \label{equ:4-nystromchebyshev-hutch-pp}
\end{equation}
If we are able to compute a good low-rank approximation, the Frobenius norm
of the residual $\mtx{\Delta}$ will be small, and, hence, the estimation
error of the Hutchinson \refequ{equ:2-chebyshev-DGC-hutchinson-variance} also.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Implementation}
\label{sec:4-nystromchebyshev-implementation}

Taking the developments from \refchp{chp:2-chebyshev} and \refchp{chp:3-nystrom},
we can combine them to a powerful hybrid method which we call the \glsfirst{NCPP}
method. Its implementations is similar to the \gls{NC} method (\refalg{alg:nystrom-chebyshev}).
The pseudocode for the \glsfirst{NCPP} is given in \refalg{alg:nystrom-chebyshev-pp}.

\begin{algo}{Nystr\"om-Chebyshev++ method}{nystrom-chebyshev-pp}
    Symmetric matrix $\mtx{A} \in \mathbb{R}^{n \times n}$, 
    \gls{chebyshev-degree}
    number of random vectors $n_v, \widetilde{n}_v$,
    evaluation points $\{t_i\}_{i=1}^{n_t}$
    \begin{algorithmic}[1]
        \State Compute $\{\mu_l(t_i)\}_{l=0}^m$ for all $t_i$ using \refequ{equ:2-chebyshev-chebyshev-DCT}
        \State Compute $\{\nu_l(t_i)\}_{l=0}^{2m}$ for all $t_i$ using \refequ{equ:3-nystrom-chebyshev-potentiate-coefficients}
        \State Generate sketching matrices $\mtx{\mtx{\Omega}} \in \mathbb{R}^{n \times n_v}, \mtx{\Psi} \in \mathbb{R}^{n \times \widetilde{n}_v}$ % TODO add \mtx{\Omega} to glossary (and Psi is only random matrix)
        \State Initialize $[\mtx{V}_1, \mtx{V}_2, \mtx{V}_3] \gets [\mtx{0}_{n \times n_v}, \mtx{\mtx{\Omega}}, \mtx{0}_{n \times n_v}]$
        \State Initialize $[\mtx{W}_1, \mtx{W}_2, \mtx{W}_3] \gets [\mtx{0}_{n \times \widetilde{n}_v}, \mtx{\Psi}, \mtx{0}_{n \times \widetilde{n}_v}]$
        \State Initialize $[\mtx{K}_1(t_i), \mtx{K}_2(t_i)] \gets [\mtx{0}_{n_v \times n_v}, \mtx{0}_{n_v \times n_v}]$ for all $t_i$
        \State Initialize $[l_1(t_i), \mtx{L}_2(t_i)] \gets [0, \mtx{0}_{n_v \times \widetilde{n}_v}]$ for all $t_i$
        \State Set ${\phi}_{\sigma}^m(t_i) \gets 0$ for $i=1,\dots,n_t$
        \For {$l = 0, \dots, 2m$}
          \State $\mtx{X} \gets \mtx{\mtx{\Omega}}^{\top} \mtx{V}_2$
          \State $\mtx{Y} \gets \mtx{\mtx{\Omega}}^{\top} \mtx{W}_2$
          \State $z \gets \Tr(\mtx{\Psi}^{\top} \mtx{W}_2$)
          \For {$i = 1, \dots, n_t$}
            \If {$l \leq m$}
                \State $\mtx{K}_1(t_i) \gets \mtx{K}_1(t_i) + \mu_l(t_i) \mtx{X}$
                \State $l_1(t_i) \gets l_1(t_i) + \nu_l(t_i) z$
            \EndIf
            \State $\mtx{K}_2(t_i) \gets \mtx{K}_2(t_i) + \nu_l(t_i) \mtx{X}$
            \State $\mtx{L}_2(t_i) \gets \mtx{L}_2(t_i) + \mu_l(t_i) \mtx{Y}$
          \EndFor
          \State $\mtx{V}_3 \gets (2 - \delta_{l0}) \mtx{A} \mtx{V}_2 - \mtx{V}_1$ \Comment{Chebyshev recurrence \refequ{equ:2-chebyshev-chebyshev-recursion}}
          \State $\mtx{V}_1 \gets \mtx{V}_2, \mtx{V}_2 \gets \mtx{V}_3$
          \State $\mtx{W}_3 \gets (2 - \delta_{l0}) \mtx{A} \mtx{W}_2 - \mtx{W}_1$ \Comment{Chebyshev recurrence \refequ{equ:2-chebyshev-chebyshev-recursion}}
          \State $\mtx{W}_1 \gets \mtx{W}_2, \mtx{W}_2 \gets \mtx{W}_3$
        \EndFor
        \For {$i = 1, \dots, n_t$}
          \State $\widetilde{\phi}_{\sigma}^m(t_i) \gets \Tr\left( \mtx{K}_1(t_i)^{\dagger}\mtx{K}_2(t_i) \right) + \frac{1}{\widetilde{n}_v} \left( l_2(t_i) + \Tr\left( \mtx{L}_1(t_i)^{\top} \mtx{K}_1(t_i)^{\dagger} \mtx{L}_1(t_i) \right)  \right) $
        \EndFor
    \end{algorithmic}
\end{algo}

With the cost of a matrix-vector product denoted with
with $c(n)$, and supposing we allocate the random vectors equally
to the low-rank approximation and the trace estimation, i.e. $n_v \approx \widetilde{n}_v$,
we determine the computational complexity of the \gls{NCPP}
method to be $\mathcal{O}(m \log(m) n_t + m n_v^2 n + m n_t n_v^2 +  m c(n) n_v + n_t n_v^3)$, with
$\mathcal{O}(n n_v + n_v^2 n_t + m n_t)$ required additional storage.

\todo{Reuse eigenvectors from generalized eigenvalues to compute last term.}

It is not hard to extend this method to the other low-rank approximations
we have mentioned in \refsec{sec:3-nystrom-other-low-rank}.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Theoretical analysis}
\label{sec:4-nystromchebyshev-analysis}

Justify choice of norm.

[Cite preprint]

\begin{lemma}{Hutchinson}{4-nystromchebyshev-hutchinson}
    Let $\mtx{B}(t) \in \mathbb{R}^{n \times n}$ symmetric and continuous in $t \in [a, b]$, $\delta \in (0, e^{-1})$, $\widetilde{n}_v \in \mathbb{n}$. Let $\Hutch_{\widetilde{n}_v}(\mtx{B}(t))$ be the $\widetilde{n}_v$-query Hutchinson estimator with standard Gaussian random vectors. For fixed constant $C_1$, with probability $\geq 1 - \delta$
    \begin{equation}
        \int_{a}^{b} \left| \Hutch_{\widetilde{n}_v}(\mtx{B}(t))  - \Tr(\mtx{B}(t)) \right| \mathrm{d}t \leq C_1 \sqrt{\frac{\log(2/\delta)}{\widetilde{n}_v}} \int_{a}^{b} \lVert \mtx{B}(t) \rVert_F \mathrm{d}t.
    \end{equation}
    So, if $\widetilde{n}_v = \mathcal{O}\left( \frac{\log(2/\delta)}{\varepsilon^2} \right)$ then, with probability $\geq 1 - \delta$, $\int |H_l(\mtx{B}(t)) - \Tr(\mtx{B}(t))| \mathrm{d}t \leq \varepsilon \int \lVert \mtx{B}(t) \rVert_F \mathrm{d}t$.
\end{lemma}

\begin{theorem}{Trace correction}{4-nystromchebyshev-trace-correction}
    Suppose $\mtx{B}(t) \in \mathbb{R}^{n \times n}$ is symmetric positive definite and continuous in $t \in [a, b]$. Let $\hat{\mtx{B}}(t)$ and $\{\mtx{\Delta}_k(t)\}_{n_v \geq 1}$ be any symmetric positive definite and continuous matrices in $t \in [a, b]$ such that:
    \begin{equation}
        \Tr(\mtx{B}(t)) = \Tr(\hat{\mtx{B}}(t)) + \Tr(\mtx{\Delta}_k(t)) \quad \text{and} \quad
        \int_{a}^{b} \lVert \mtx{\Delta}_k(t) \rVert _F \mathrm{d}t \leq C_2\frac{1}{\sqrt{n_v}} \int_{a}^{b} \Tr(\mtx{B}(t)) \mathrm{d}t.
    \end{equation}
    For a fixed constant $C$ and with probability $\geq 1 - \delta$, $Z(t) = \Tr(\hat{\mtx{B}}(t)) + \Hutch_l(\mtx{\Delta}_k(t))$ satisfies:
    \begin{equation}
        \int_{a}^{b} |Z(t) - \Tr(\mtx{\Delta}_k(t))| \mathrm{d}t \leq C \sqrt{\frac{\log(2/\delta)}{kl}} \int_{a}^{b} \Tr(\mtx{B}(t)) \mathrm{d}t
    \end{equation}
    In particular, if $n_v=\widetilde{n}_v=\mathcal{O}\left( \frac{\sqrt{\log(2/\delta)}}{\varepsilon} \right)$, $Z(t)$ is a $(1 \pm \varepsilon)$ error approximation to $\Tr(\mtx{B}(t))$.
\end{theorem}

\begin{proof}
    \begin{align*}
        \int_{a}^{b} |Z(t) - \Tr(\mtx{B}(t))| \mathrm{d}t
        &= \int_{a}^{b} |\Hutch_l(\mtx{\Delta}_k(t)) - \Tr(\mtx{\Delta}_k(t))| \mathrm{d}t && \text{(by definition of $Z(t)$)} \\
        &= C_1 \sqrt{\frac{\log(2/\delta)}{\widetilde{n}_v}} \int_{a}^{b} \lVert \mtx{\Delta}_k(t) \rVert _F \mathrm{d}t && \text{(using \refthm{lem:4-nystromchebyshev-hutchinson})} \\
        &= C_1 C_2 \sqrt{\frac{\log(2/\delta)}{kl}} \int_{a}^{b} \Tr(\mtx{B}(t)) \mathrm{d}t && \text{(assumption on $\mtx{\Delta}_k(t)$)} \\
    \end{align*}
    Taking $C=C_1 C_2$, we get the desired result with probability $\geq 1 - \delta$.
\end{proof}

[Cite preprint]

\begin{lemma}{Parameter-dependent Nystr\"om approximation}{4-nystromchebyshev-parameter-nystrom}
    Let $\mtx{B}(t) \in \mathbb{R}^{n \times n}$ symmetric positive definite and continuous in $t \in [a, b]$. Then the parameter-dependent Nystr\"om approximation
    \begin{equation}
        \hat{\mtx{B}}(t) = (\mtx{B}(t) \mtx{\Omega}) (\mtx{\Omega}^{\top} \mtx{B}(t) \mtx{\Omega})^{\dagger} (\mtx{B}(t) \mtx{\Omega})^{\top}
    \end{equation}
    with $\mtx{\Omega} \in \mathbb{R}^{n \times n_v}$ a standard Gaussian matrix, $n_v \geq 8 \log(1/\delta)$, and constant $C_2$, satisfies with probability $\geq 1 - \delta$
    \begin{equation}
        \int_{a}^{b} \lVert \mtx{B}(t) - \hat{\mtx{B}}(t) \rVert _F \mathrm{d}t \leq C_2 \frac{1}{\sqrt{n_v}} \int_{a}^{b} \Tr(\mtx{B}(t)) \mathrm{d}t.
    \end{equation}
\end{lemma}

\begin{theorem}{Final}{4-nystromchebyshev-final}
    The parameter-dependent Nystr\"om++ computed with $N_{n_v} = N_{\widetilde{n}_v} = \mathcal{O}\left( \frac{\sqrt{\log(2/\delta)}}{\varepsilon} + \log(1/\delta) \right)$ for any symmetric positive definite matrix $\mtx{B}(t)$ which continuously depends on $t \in [a, b]$ satisfies, with probability $1 - \delta$: $(1 - \varepsilon) \int \Tr(\mtx{B}(t)) \mathrm{d}t \leq \int \Tr^{n++}(\mtx{B}(t)) \mathrm{d}t \leq  (1 + \varepsilon) \int \Tr(\mtx{B}(t)) \mathrm{d}t$.
\end{theorem}

\begin{proof}
    According to \refthm{thm:4-nystromchebyshev-trace-correction} it is enough to verify that the Nystr\"om approximation $\hat{\mtx{B}}(t)$ of $\mtx{B}(t)$ satisfies
    \begin{equation}
        \Tr(\mtx{B}(t)) = \Tr(\hat{\mtx{B}}(t) + \mtx{B}(t) - \hat{\mtx{B}}(t)) = \Tr(\hat{\mtx{B}}(t)) + \Tr(\mtx{\Delta}(t))
    \end{equation}
    for all $t \in [a, b]$ and with probability $\geq 1 - \delta$
    \begin{equation}
        \int_{a}^{b} \lVert \mtx{\Delta}_k(t) \rVert _F \mathrm{d}t = \int_{a}^{b} \lVert \mtx{B}(t) - \hat{\mtx{B}}(t) \rVert _F \mathrm{d}t \leq C_2 \frac{1}{\sqrt{n_v}} \int_{a}^{b} \Tr(\mtx{B}(t)) \mathrm{d}t.
    \end{equation}
    The latter follows from \reflem{lem:4-nystromchebyshev-parameter-nystrom}. Finally, the choices of $N_{\widetilde{n}_v}$ and $N_{n_v}$ follow from \refthm{thm:4-nystromchebyshev-trace-correction} and \reflem{lem:4-nystromchebyshev-parameter-nystrom}.
\end{proof}

\Refthm{thm:4-nystromchebyshev-trace-correction} allows us to almost immediately
also conclude $1/\varepsilon$ result for the higher order approximations
\refequ{equ:3-nystrom-trace-generalization}.

For RSVD ($k=2$), we use \cite[Theorem~9.1]{halko2011finding}
\begin{equation}
    \lVert (\mtx{I} - \Pi_{\mtx{B}\mtx{\Omega}}) \mtx{B} \rVert _F \leq \lVert \mtx{\Lambda}_2 \rVert _F + \lVert \mtx{\Lambda}_2 \mtx{\Omega}_2 \mtx{\Omega}_1^{\dagger} \rVert _F.
\end{equation}
Result from parameter-dependent Nyström++ \todo{[cite preprint]}
\begin{equation}
    %\mathbb{E}^n_v\left[ \lVert \mtx{\Omega}_1^{\dagger} \rVert _F^2 \right] \leq C
    \mathbb{E}^{n_v/2} \left[ \lVert \mtx{\Lambda}_2 \mtx{\Omega}_2 \mtx{\Omega}_1^{\dagger} \rVert _F \right] \leq C(\sqrt{n_v} \lVert \mtx{\Lambda}_2 \rVert _2 + \lVert \mtx{\Lambda}_2 \rVert _F),% \leq 2 C \cdot \frac{\operatorname{Tr}(\mtx{B})}{\sqrt{n_v}}
\end{equation}
where $n_v$ hence
\begin{equation}
    \mathbb{E}^{n_v/2} \left[ \lVert (\mtx{I} - \Pi_{\mtx{B}\mtx{\Omega}}) \mtx{B} \rVert _F \right]
    \leq (1 + 2C) \cdot \frac{\operatorname{Tr}(\mtx{B})}{\sqrt{n_v}}.
\end{equation}
By Markov's and Minkowski's inequalities we have for $n_v \geq 2 \log(1/\delta)$ with probability $\geq 1 - \delta$
\begin{equation}
    \int \lVert  (\mtx{I} - \Pi_{\mtx{B}(t)\mtx{\Omega}}) \mtx{B}(t) \rVert _F \mathrm{d}t \leq (1 + 2C) e \int \frac{\operatorname{Tr}(\mtx{B}(t))}{\sqrt{n_v}} \mathrm{d}t
\end{equation}

For Nystr\"om with one subspace iteration ($k=3$) we apply \cite[Lemma~5.2]{tropp2023randomized}
to directly conclude from the RSVD case.

Have result for all $k \geq 1$, but issue with implementation, since we do not
have access to column sketch (whose QR-factorization is crucial for stability).

\todo{Put together all errors (Nyström, Chebyshev, Hutchinson)}
